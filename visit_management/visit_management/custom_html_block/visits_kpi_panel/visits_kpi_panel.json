{
 "doctype": "Custom HTML Block",
 "name": "Visits KPI Panel",
 "html": "<div class=\"vm-kpi-panel\">\n  <div class=\"vm-kpi-toolbar\">\n    <div class=\"left d-flex align-items-center\">\n      <div class=\"btn-group btn-group-sm mr-2\">\n        <button type=\"button\" class=\"btn btn-default vm-mode-btn active\" data-mode=\"my\">My</button>\n        <button type=\"button\" class=\"btn btn-default vm-mode-btn\" data-mode=\"team\">Team</button>\n      </div>\n      <div class=\"vm-agent d-none\">\n        <label class=\"mr-2 text-muted\">Agent</label>\n        <select class=\"form-control input-sm vm-agent-select\"><option value=\"\">All</option></select>\n      </div>\n    </div>\n    <div class=\"right d-flex align-items-center\">\n      <div class=\"vm-period mr-2\">\n        <label class=\"mr-2 text-muted\">Period</label>\n        <select class=\"form-control input-sm vm-period-select\">\n          <option value=\"today\">Today</option>\n          <option value=\"week\">This Week</option>\n          <option value=\"month\" selected> This Month</option>\n          <option value=\"quarter\">This Quarter</option>\n          <option value=\"year\">This Year</option>\n        </select>\n      </div>\n      <div class=\"form-check form-check-inline\">\n        <input class=\"form-check-input vm-overdue-scope\" type=\"checkbox\" id=\"vmOverdueScope\">\n        <label class=\"form-check-label\" for=\"vmOverdueScope\">Overdue within period</label>\n      </div>\n      <span class=\"vm-role-hint badge badge-warning ml-2 d-none\">Limited to My</span>\n    </div>\n  </div>\n  <div class=\"vm-kpis row\">\n    <div class=\"col-md-3 col-sm-6 vm-kpi\">\n      <div class=\"kpi-card planned\">\n        <div class=\"kpi-label\">Planned</div>\n        <div class=\"kpi-value\" data-key=\"planned\">–</div>\n      </div>\n    </div>\n    <div class=\"col-md-3 col-sm-6 vm-kpi\">\n      <div class=\"kpi-card in-progress\">\n        <div class=\"kpi-label\">In Progress</div>\n        <div class=\"kpi-value\" data-key=\"in_progress\">–</div>\n      </div>\n    </div>\n    <div class=\"col-md-3 col-sm-6 vm-kpi\">\n      <div class=\"kpi-card completed\">\n        <div class=\"kpi-label\">Completed</div>\n        <div class=\"kpi-value\" data-key=\"completed\">–</div>\n      </div>\n    </div>\n    <div class=\"col-md-3 col-sm-6 vm-kpi\">\n      <div class=\"kpi-card overdue\">\n        <div class=\"kpi-label\">Overdue</div>\n        <div class=\"kpi-value\" data-key=\"overdue\">–</div>\n      </div>\n    </div>\n  </div>\n</div>",
 "script": "(function(){\n    var $ = window.jQuery;\n    var panel = root_element;\n    var state = { mode: 'my', period: 'month', user: '', overdue_within_period: false, is_manager: false };\n\n    function setMode(mode, showHint) {\n        state.mode = mode;\n        $(panel).find('.vm-mode-btn').removeClass('active');\n        $(panel).find('.vm-mode-btn[data-mode=\"' + mode + '\"]').addClass('active');\n        $(panel).find('.vm-role-hint').toggleClass('d-none', !showHint);\n        $(panel).find('.vm-agent').toggleClass('d-none', !(mode === 'team' && state.is_manager));\n    }\n\n    function setPeriod(period) {\n        state.period = period;\n        $(panel).find('.vm-period-select').val(period);\n    }\n\n    function setUser(user){\n        state.user = user || '';\n    }\n\n    function renderValues(data){\n        var keys = ['planned','in_progress','completed','overdue'];\n        for (var i=0;i<keys.length;i++){\n            var k = keys[i];\n            var val = data[k] || 0;\n            $(panel).find('.kpi-value[data-key=\"' + k + '\"]').text(String(val));\n        }\n        state.is_manager = !!data.is_manager;\n        if (data.effective_mode && data.effective_mode !== state.mode) {\n            setMode(data.effective_mode, true);\n        } else {\n            $(panel).find('.vm-role-hint').toggleClass('d-none', !!state.is_manager);\n        }\n        $(panel).find('.vm-agent').toggleClass('d-none', !(state.mode === 'team' && state.is_manager));\n    }\n\n    function refresh(){\n        return frappe.call({\n            method: 'visit_management.utils.get_visit_kpis',\n            args: { mode: state.mode, period: state.period, user: state.user, overdue_within_period: state.overdue_within_period },\n        }).then(function(res){\n            renderValues((res && res.message) || {});\n        });\n    }\n\n    function loadAgents(){\n        return frappe.call({\n            method: 'visit_management.utils.get_visit_assignees'\n        }).then(function(res){\n            var list = ((res && res.message) || []).filter(Boolean);\n            var $sel = $(panel).find('.vm-agent-select');\n            $sel.empty();\n            $sel.append('<option value=\"\">All</option>');\n            list.forEach(function(u){ $sel.append('<option value=\"'+u+'\">'+frappe.utils.escape_html(u)+'</option>'); });\n        });\n    }\n\n    $(panel).find('.vm-mode-btn').on('click', function(){\n        var mode = $(this).data('mode');\n        setMode(mode, false);\n        refresh();\n    });\n    $(panel).find('.vm-period-select').on('change', function(){\n        var period = $(this).val();\n        setPeriod(period);\n        refresh();\n    });\n    $(panel).find('.vm-agent-select').on('change', function(){\n        setUser($(this).val());\n        refresh();\n    });\n    $(panel).find('.vm-overdue-scope').on('change', function(){\n        state.overdue_within_period = $(this).is(':checked');\n        refresh();\n    });\n\n    setMode('my', false);\n    setPeriod('month');\n    loadAgents().then(refresh);\n})();",
 "style": ".vm-kpi-panel{padding:8px 0} .vm-kpi-toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px} .vm-kpi .kpi-card{background:#fff;border:1px solid var(--border-color, #d1d8dd);border-radius:6px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,0.03)} .kpi-label{font-size:12px;color:#6c757d;text-transform:uppercase;letter-spacing:.04em} .kpi-value{font-size:24px;font-weight:700;margin-top:4px} .kpi-card.planned{border-left:4px solid #6c757d} .kpi-card.in-progress{border-left:4px solid #17a2b8} .kpi-card.completed{border-left:4px solid #28a745} .kpi-card.overdue{border-left:4px solid #dc3545}",
 "roles": []
}
